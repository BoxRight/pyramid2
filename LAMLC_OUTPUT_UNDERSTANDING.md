# lamlc Output Understanding - Hands-On Analysis

## What lamlc Actually Generates

### 1. **AST JSON File** (via `--ast-json` flag)
**Location**: Specified path (e.g., `contracts/test_ast_output.json`)
**Generated**: Once per compilation
**Format**: Hierarchical structure
```json
{
  "type": "LAML_AST",
  "version": "2.0",
  "ast_type": "hierarchical",
  "imports": [...],
  "institutions": [...],
  "statements": [...],
  "rules": [...]
}
```

**Used by**: `backend.lib.ast_contract_parser` for HTML generation

### 2. **Results JSON Files** (automatic)
**Location**: Project root directory (where lamlc is executed)
**Generated**: One file per `.valid()` call
**Naming**: `laml_results_{instance_name}.json`
**Format**: Solver output with solutions
```json
{
  "satisfiable": true,
  "mappings": {
    "1": {"predicate": "...", "args": [...], "full": "..."}
  },
  "solutions": [[1, 2], [1, 2, 3]],
  "num_solutions": 4,
  "claims": {...}
}
```

**Used by**: `backend.lib.violation_analysis` for analysis

## Actual lamlc Execution

```bash
./lamlc contracts/solar_lease_simple.laml --ast-json contracts/test_ast_output.json
```

**Output**:
1. ✅ AST file: `contracts/test_ast_output.json` (28KB)
2. ✅ Results: `laml_results_core_lease_component.json` (24KB) - component
3. ✅ Results: `laml_results_simple_solar_contract.json` (1.2KB) - final contract

**Key Observations**:
- AST file is written to the specified path
- Results files are **always** written to the **current working directory** (project root)
- Multiple `.valid()` calls = multiple result files
- Results files are sorted by modification time to determine execution order

## Python Script Interaction

### `backend.lib.violation_analysis` (LAMLViolationAnalyzer)
```python
analyzer = LAMLViolationAnalyzer('laml_results_simple_solar_contract.json')
# Reads: mappings, solutions, num_solutions
# Analyzes: violation scenarios, consequences
```

**Expects**: Results JSON file (solver output)
**Location**: Can be anywhere, but lamlc generates in project root

### `backend.lib.ast_contract_parser` (ASTContractParser)
```python
parser = ASTContractParser('test_ast.json', use_api_improvement=False)
contract = parser.parse_contract()
# Reads: institutions, statements, rules, bindings
# Generates: HTML contract structure
```

**Expects**: AST JSON file (hierarchical structure)
**Location**: Specified by `--ast-json` flag

## Backend Implementation

### Current Behavior
1. **AST Generation**:
   - Writes to: `contracts/{contract_id}_ast.json` (relative to project root)
   - Backend reads this file and stores in `data/compiled/ast/`

2. **Results Files**:
   - Generated in: Project root (`laml_results_*.json`)
   - Backend finds all `laml_results_*.json` files in project root
   - Stores final contract results in `data/compiled/results/`
   - Component results metadata stored (references original files)

### File Paths

```
Project Root
├── contracts/
│   ├── {contract_id}_ast.json          # AST (generated by --ast-json)
│   └── {contract_id}.laml              # Temporary LAML file
├── laml_results_core_lease_component.json    # Component results (generated by lamlc)
├── laml_results_simple_solar_contract.json   # Final contract results (generated by lamlc)
└── data/
    ├── compiled/
    │   ├── ast/
    │   │   └── {contract_id}.json      # AST (copied from contracts/)
    │   └── results/
    │       └── {contract_id}_{instance}.json  # Results (copied from root)
```

## Key Insights

1. **AST is single file** per compilation (hierarchical structure of entire contract)
2. **Results are multiple files** per compilation (one per `.valid()` call)
3. **Results files in project root** - lamlc always writes them there
4. **AST file location** - specified by `--ast-json` flag
5. **Execution order** - determined by modification time of result files
6. **Final contract** - last `.valid()` call = last modified result file

## Testing Verification

✅ **AST Parsing**: `ASTContractParser` successfully reads AST and generates contract structure
✅ **Results Analysis**: `LAMLViolationAnalyzer` successfully analyzes solver output
✅ **File Locations**: Both file types are correctly generated and accessible
✅ **Backend Storage**: Backend correctly separates AST and results into different folders

## Workflow

1. **Compile**: `lamlc` generates AST + results files
2. **Store AST**: Copy to `data/compiled/ast/{contract_id}.json`
3. **Store Results**: Copy final to `data/compiled/results/{contract_id}_{instance}.json`
4. **Store Metadata**: Track all component results
5. **HTML Generation**: Use AST file
6. **Analysis/Query**: Use results file

