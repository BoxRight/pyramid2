# File Structure - Corrected Understanding

## Two Types of Compiled Files

### 1. **AST (Abstract Syntax Tree)** - Hierarchical Structure
**Location**: `data/compiled/ast/{contract_id}.json`

**Generated by**: `lamlc --ast-json ast.json`

**Format**:
```json
{
  "type": "LAML_AST",
  "version": "2.0",
  "ast_type": "hierarchical",
  "imports": [...],
  "institutions": [
    {
      "type": "Institution",
      "name": "...",
      "parameters": [...],
      "bindings": [...],
      "statements": [...],
      "rules": [...]
    }
  ]
}
```

**Used by**:
- `backend.lib.ast_contract_parser` → Generates HTML contracts
- Contract visualization
- Contract structure analysis

**Purpose**: Represents the hierarchical structure of the LAML code

### 2. **Results (Solver Output)** - Solution Space
**Location**: `data/compiled/results/{contract_id}_{instance_name}.json`

**Generated by**: `lamlc` (automatically as `laml_results_{instance_name}.json`)

**Format**:
```json
{
  "satisfiable": true,
  "mappings": {
    "1": {"predicate": "...", "args": [...], "full": "..."}
  },
  "solutions": [[1, 2], [1, 2, 3]],
  "num_solutions": 4,
  "claims": {
    "obligations": [...],
    "prohibitions": [...]
  }
}
```

**Used by**:
- `backend.lib.violation_analysis` → Analyzes violations/fulfillments
- Query service → Answers predicate queries
- Analysis service → Generates analysis results

**Purpose**: Contains the solution space from the solver

## Storage Structure

```
data/
├── compiled/
│   ├── ast/                    # AST (hierarchical structure)
│   │   └── {contract_id}.json
│   └── results/                # Results (solver output)
│       └── {contract_id}_{instance_name}.json
├── source/contracts/           # LAML source files
├── analysis/results/           # Analysis results
└── generated/html/            # Rendered HTML
```

## Backend Implementation

### Compilation (`contract_compiler.py`)
1. Generate AST: `--ast-json {contract_id}_ast.json`
2. Generate results: `lamlc` automatically creates `laml_results_*.json`
3. Store AST in: `data/compiled/ast/{contract_id}.json`
4. Store results in: `data/compiled/results/{contract_id}_{instance_name}.json`

### Analysis (`contract_analyzer.py`)
- Uses **results file** (solver output)
- NOT the AST file
- `LAMLViolationAnalyzer` expects results format

### Contract Parser (`backend.lib.ast_contract_parser`)
- Uses **AST file** (hierarchical structure)
- NOT the results file
- Expects `type: "LAML_AST"` format

### HTML Renderer (`contract_renderer.py`)
- Uses **AST file** for contract structure
- Generates HTML from hierarchical structure

## Key Distinction

| Aspect | AST | Results |
|--------|-----|---------|
| **Purpose** | Code structure | Solution space |
| **Format** | Hierarchical | Flat with mappings |
| **Contains** | Institutions, rules, statements | Solutions, mappings, satisfiability |
| **Used for** | HTML generation, visualization | Analysis, queries |
| **Script** | `backend.lib.ast_contract_parser` | `backend.lib.violation_analysis` |

## Fixed Issues

✅ **Before**: Stored results in AST folder
✅ **After**: Separate folders for AST and results
✅ **Before**: Missing AST generation
✅ **After**: Generates AST with `--ast-json` flag
✅ **Before**: Analyzer used wrong file type
✅ **After**: Analyzer uses results, parser uses AST

